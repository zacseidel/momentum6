name: Weekly Momentum Report

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 9 * * 5'

# ✅ Add Pages permissions
permissions:
  contents: write
  pages: write
  id-token: write

# (Optional) keep only one live deployment at a time
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    # ✅ REQUIRED by actions/deploy-pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    env:
      POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      MPLBACKEND: Agg

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run weekly report (Friday anchor)
        run: python run_report.py

      - name: Update index page
        run: python generate_index.py

      - name: Debug verify index and changes
        run: |
          echo "=== Top of index.html ==="
          sed -n '1,80p' index.html
          echo
          echo "=== Has 2025-09-12? ==="
          grep -n "2025-09-12" index.html || true
          echo
          echo "=== Git status (before commit) ==="
          git status --porcelain
          echo
          echo "=== Changed files ==="
          git diff --name-only || true
          echo
          echo "=== Reports dir ==="
          ls -lah reports | tail -n +1

      - name: Debug git branch & remote
        run: |
          echo "=== Current branch ==="
          git rev-parse --abbrev-ref HEAD || true
          echo "=== Remote ==="
          git remote -v || true

      - name: Commit & push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: ${{ github.ref_name }}
          commit_message: "chore(reports): weekly update [skip ci]"
          # Make sure we stage EVERYTHING we care about, even if untracked
          add_options: -A

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'   # publish repo root

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
